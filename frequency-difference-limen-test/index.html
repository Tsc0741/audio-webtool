<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABX Psychoacoustic Listening Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 90%;
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .test-info {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .test-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .test-details {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .control-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            min-width: 120px;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .control-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .choice-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .choice-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            min-width: 150px;
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .choice-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress {
            margin: 30px 0;
            background: #ecf0f1;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            margin-top: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .results {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #27ae60;
        }

        .results h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .instructions {
            background: #fff3cd;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #ffc107;
            text-align: left;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ol {
            color: #856404;
            margin-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .status {
            font-size: 1.2em;
            font-weight: 600;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #e8f5e8;
            color: #2d5a3d;
        }

        .start-button {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            margin: 20px 0;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .choice-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ABX Psychoacoustic Test</h1>
        <p class="subtitle">Frequency Discrimination Threshold Assessment</p>
        
        <div class="instructions">
            <h3>How it works:</h3>
            <ol>
                <li><strong>Reference X:</strong> Always 440 Hz (concert A)</li>
                <li><strong>Test A & B:</strong> One is 440 Hz, the other varies</li>
                <li><strong>Your task:</strong> Which sounds more like X - A or B?</li>
                <li>Listen to each tone for 0.8 seconds</li>
                <li>Vote for the tone that sounds most similar to the reference</li>
            </ol>
        </div>
        
        <div id="welcome-screen">
            <button class="start-button" onclick="startTest()">Start Test</button>
        </div>
        
        <div id="test-screen" style="display: none;">
            <div class="test-info">
                <div class="test-title">ABX Frequency Discrimination Test</div>
                <div class="test-details">Listen carefully and choose which tone (A or B) sounds most similar to the reference tone X</div>
            </div>
            
            <div class="status" id="status">Click "Play X" to begin</div>
            
            <div class="controls">
                <button class="control-button" id="playX" onclick="playTone('X')">Play X (Reference)</button>
                <button class="control-button" id="playA" onclick="playTone('A')" disabled>Play A</button>
                <button class="control-button" id="playB" onclick="playTone('B')" disabled>Play B</button>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-button" id="choiceA" onclick="makeChoice('A')" disabled>A sounds like X</button>
                <button class="choice-button" id="choiceB" onclick="makeChoice('B')" disabled>B sounds like X</button>
            </div>
            
            <div class="progress">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text">0 / 0 trials completed</div>
        </div>
        
        <div id="results-screen" style="display: none;">
            <div class="results">
                <h3>Test Results</h3>
                <div id="results-content"></div>
                <button class="start-button" onclick="resetTest()" style="margin-top: 20px;">Take Test Again</button>
            </div>
        </div>
    </div>

    <script>
        // Audio context and test configuration
        let audioContext;
        let currentTrial = 0;
        let testResults = [];
        let hasPlayedX = false;
        let hasPlayedA = false;
        let hasPlayedB = false;
        let currentFreqA, currentFreqB;
        let correctChoice;
        let testSequence = [];
        let currentTestIndex = 0;
        
        // Test configuration (hidden from user)
        const testConfigs = [
            { name: "Control Test", description: "440 Hz vs 440 Hz (0% difference)", baseFreq: 440, testFreq: 440, percentage: 0, label: "0%" },
            { name: "±0.1% Test", description: "440 Hz vs 440.4 Hz (0.1% = 0.4 Hz difference)", baseFreq: 440, testFreq: 440.4, percentage: 0.1, label: "±0.1%" },
            { name: "±0.15% Test", description: "440 Hz vs 440.66 Hz (0.15% = 0.66 Hz difference)", baseFreq: 440, testFreq: 440.66, percentage: 0.15, label: "±0.15%" },
            { name: "±0.2% Test", description: "440 Hz vs 440.9 Hz (0.2% = 0.9 Hz difference)", baseFreq: 440, testFreq: 440.9, percentage: 0.2, label: "±0.2%" },
            { name: "±0.5% Test", description: "440 Hz vs 442.2 Hz (0.5% = 2.2 Hz difference)", baseFreq: 440, testFreq: 442.2, percentage: 0.5, label: "±0.5%" },
            { name: "±1% Test", description: "440 Hz vs 444.4 Hz (1% = 4.4 Hz difference)", baseFreq: 440, testFreq: 444.4, percentage: 1.0, label: "±1%" }
        ];
        
        const trialsPerCondition = 5;
        const totalTrials = testConfigs.length * trialsPerCondition;
        
        function startTest() {
            // Initialize audio context
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Create randomized test sequence (5 trials for each of 6 conditions = 30 total)
            testSequence = [];
            testConfigs.forEach(config => {
                for (let i = 0; i < trialsPerCondition; i++) {
                    testSequence.push(config);
                }
            });
            
            // Shuffle the test sequence randomly
            for (let i = testSequence.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [testSequence[i], testSequence[j]] = [testSequence[j], testSequence[i]];
            }
            
            // Initialize test state
            currentTrial = 0;
            currentTestIndex = 0;
            testResults = [];
            
            // Show test screen
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('test-screen').style.display = 'block';
            
            setupTrial();
        }
        
        function setupTrial() {
            const currentConfig = testSequence[currentTestIndex];
            
            // Update progress
            document.getElementById('status').textContent = "Click 'Play X' to begin";
            document.getElementById('progress-text').textContent = `${currentTrial} / ${totalTrials} trials completed`;
            document.getElementById('progress-bar').style.width = `${(currentTrial / totalTrials) * 100}%`;
            
            // For non-control tests, randomly choose sharp or flat
            let testFreq;
            if (currentConfig.percentage === 0) {
                // Control condition - both frequencies are the same
                testFreq = currentConfig.baseFreq;
            } else {
                // Randomly choose sharp (higher) or flat (lower)
                if (Math.random() < 0.5) {
                    testFreq = currentConfig.baseFreq * (1 + currentConfig.percentage / 100); // Sharp
                } else {
                    testFreq = currentConfig.baseFreq * (1 - currentConfig.percentage / 100); // Flat
                }
            }
            
            // Randomize A and B assignment
            if (Math.random() < 0.5) {
                currentFreqA = currentConfig.baseFreq; // Reference frequency
                currentFreqB = testFreq; // Test frequency (sharp or flat)
                correctChoice = 'A'; // A is the reference frequency
            } else {
                currentFreqA = testFreq; // Test frequency (sharp or flat)
                currentFreqB = currentConfig.baseFreq; // Reference frequency
                correctChoice = 'B'; // B is the reference frequency
            }
            
            // Reset button states
            resetButtonStates();
        }
        
        function resetButtonStates() {
            hasPlayedX = false;
            hasPlayedA = false;
            hasPlayedB = false;
            
            document.getElementById('playX').disabled = false;
            document.getElementById('playA').disabled = true;
            document.getElementById('playB').disabled = true;
            document.getElementById('choiceA').disabled = true;
            document.getElementById('choiceB').disabled = true;
        }
        
        function playTone(tone) {
            let frequency;
            
            switch(tone) {
                case 'X':
                    frequency = 440; // Reference is always 440 Hz
                    hasPlayedX = true;
                    document.getElementById('playA').disabled = false;
                    document.getElementById('status').textContent = "Now play A and B to compare";
                    break;
                case 'A':
                    frequency = currentFreqA;
                    hasPlayedA = true;
                    break;
                case 'B':
                    frequency = currentFreqB;
                    hasPlayedB = true;
                    break;
            }
            
            // Enable choice buttons if both A and B have been played
            if (hasPlayedA && hasPlayedB) {
                document.getElementById('choiceA').disabled = false;
                document.getElementById('choiceB').disabled = false;
                document.getElementById('status').textContent = "Which sounds more like X? Choose A or B";
            }
            
            // Generate and play tone
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            // Envelope for smooth start/stop (0.8 seconds total)
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + 0.75);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.8);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.8);
            
            // Disable all buttons during playback
            disableAllButtons();
            setTimeout(() => {
                enableAppropriateButtons();
            }, 800);
        }
        
        function disableAllButtons() {
            document.getElementById('playX').disabled = true;
            document.getElementById('playA').disabled = true;
            document.getElementById('playB').disabled = true;
            document.getElementById('choiceA').disabled = true;
            document.getElementById('choiceB').disabled = true;
        }
        
        function enableAppropriateButtons() {
            document.getElementById('playX').disabled = false;
            if (hasPlayedX) {
                document.getElementById('playA').disabled = false;
                document.getElementById('playB').disabled = false;
            }
            if (hasPlayedA && hasPlayedB) {
                document.getElementById('choiceA').disabled = false;
                document.getElementById('choiceB').disabled = false;
            }
        }
        
        function makeChoice(choice) {
            const currentConfig = testSequence[currentTestIndex];
            const isCorrect = choice === correctChoice;
            
            // Determine if the test frequency was sharp or flat
            let direction = 'same';
            if (currentConfig.percentage > 0) {
                const testFreq = choice === correctChoice ? 
                    (choice === 'A' ? currentFreqB : currentFreqA) : 
                    (choice === 'A' ? currentFreqA : currentFreqB);
                direction = testFreq > currentConfig.baseFreq ? 'sharp' : 'flat';
            }
            
            // Store result with test configuration info
            testResults.push({
                trial: currentTrial + 1,
                choice: choice,
                correct: isCorrect,
                freqA: currentFreqA,
                freqB: currentFreqB,
                correctChoice: correctChoice,
                testCondition: currentConfig.name,
                percentage: currentConfig.percentage,
                label: currentConfig.label,
                direction: direction
            });
            
            // Move to next trial
            currentTrial++;
            currentTestIndex++;
            
            if (currentTestIndex >= testSequence.length) {
                // Test complete
                showResults();
                return;
            }
            
            // Setup next trial
            setupTrial();
        }
        
        function showResults() {
            document.getElementById('test-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            
            // Calculate accuracy for each frequency difference
            const accuracyByFrequency = {};
            testConfigs.forEach(config => {
                const relevantResults = testResults.filter(r => r.percentage === config.percentage);
                const correctCount = relevantResults.filter(r => r.correct).length;
                const accuracy = relevantResults.length > 0 ? (correctCount / relevantResults.length * 100) : 0;
                accuracyByFrequency[config.percentage] = {
                    accuracy: accuracy,
                    correct: correctCount,
                    total: relevantResults.length,
                    label: config.label
                };
            });
            
            // Sort by frequency difference for display
            const sortedResults = Object.entries(accuracyByFrequency)
                .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));
            
            let resultsHTML = `
                <div style="margin-bottom: 25px;">
                    <h4>Accuracy vs Frequency Difference</h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            `;
            
            // Create a simple text-based chart
            sortedResults.forEach(([percentage, data]) => {
                const barWidth = Math.max(data.accuracy, 5); // Minimum 5% width for visibility
                resultsHTML += `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            <span style="width: 60px; font-weight: bold;">${data.label}:</span>
                            <div style="background: linear-gradient(90deg, #3498db, #2980b9); width: ${barWidth}%; height: 25px; border-radius: 5px; margin-left: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; min-width: 40px;">
                                ${data.accuracy.toFixed(1)}%
                            </div>
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-left: 70px;">
                            ${data.correct}/${data.total} trials correct
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += `
                    </div>
                </div>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: left;">
                    <h4>Summary:</h4>
                    <p><strong>Total Trials:</strong> ${testResults.length} (${trialsPerCondition} per frequency difference)</p>
                    <p><strong>Test Duration:</strong> 0.8 seconds per tone</p>
                    <p><strong>Interpretation:</strong> Higher accuracy at larger frequency differences indicates better discrimination ability. 
                    Chance performance is ~50%. Scores above 70% suggest reliable discrimination at that frequency difference.
                    Each test randomly uses sharp (higher) or flat (lower) frequencies to prevent bias.</p>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = resultsHTML;
            
            // Log detailed results to console for research purposes
            console.log('ABX Test Results - Accuracy by Frequency:', accuracyByFrequency);
            console.log('Detailed trial data:', testResults);
        }
        
        function resetTest() {
            document.getElementById('results-screen').style.display = 'none';
            document.getElementById('welcome-screen').style.display = 'block';
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }
    </script>
</body>
</html>